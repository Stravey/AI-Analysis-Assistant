<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç”¨æˆ·æƒé™ç®¡ç† - è¶…çº§ç®¡ç†å‘˜</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* ä¸‹æ‹‰èœå•æƒé™ç±»åˆ«æ ·å¼ */
        .permission-category-dropdown {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: #f9fafb;
        }

        .permission-category-dropdown h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0.5rem 0;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .permission-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .permission-item:hover {
            background: #f3f4f6;
        }

        .permission-checkbox {
            margin-right: 0.5rem;
            margin-top: 0.25rem;
        }

        .permission-label {
            font-size: 0.875rem;
            color: #374151;
            line-height: 1.4;
        }

        /* æƒé™ç±»åˆ«æ ·å¼ */
        .permission-category {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: #f8fafc;
        }

        .permission-category strong {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.875rem;
        }

        .permission-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .permission-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* å…¨é€‰å’Œç±»åˆ«é€‰æ‹©æ ·å¼ */
        .select-all-section {
            padding: 0.5rem;
            margin-bottom: 1rem;
            background: #e0f2fe;
            border-radius: 6px;
            font-weight: 600;
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            background: #f1f5f9;
            border-radius: 4px;
        }

        .category-header input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .category-header label {
            font-weight: 600;
            color: #374151;
        }

        /* æƒé™ç®¡ç†é¡µé¢æ ·å¼ */
        .admin-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .admin-title {
            color: #3b82f6;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .admin-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .refresh-btn, .export-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover, .export-btn:hover {
            background: #f3f4f6;
        }

        .btn-back {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-back:hover {
            background-color: #2980b9;
            text-decoration: none;
        }

        .btn-back i {
            font-size: 12px;
        }

        .user-search {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 250px;
        }

        /* ç”¨æˆ·æƒé™è¡¨æ ¼æ ·å¼ */
        .permissions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .permissions-table th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .permissions-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        .permissions-table tr:hover {
            background: #f9fafb;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .username {
            font-weight: 600;
            color: #111827;
        }

        .user-email {
            font-size: 0.875rem;
            color: #6b7280;
        }


        /* è§’è‰²ç®¡ç†æ ·å¼ */
        .single-role-management {
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .role-dropdown {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            min-width: 200px;
            background: white;
        }

        .current-role-display {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #e0f2fe;
            border-radius: 6px;
            text-align: center;
        }

        .current-role-badge {
            background: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .role-change-section {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .role-dropdown {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            flex: 1;
            background: white;
        }

        .change-role-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .change-role-btn:hover {
            background: #059669;
        }

        .role-info {
            text-align: center;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        /* æƒé™ä¸‹æ‹‰èœå•æ ·å¼ */
        .permissions-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .dropdown-toggle:hover {
            background: #2563eb;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 1rem;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .permission-item:hover {
            background: #f3f4f6;
        }

        .permission-checkbox {
            margin-right: 0.5rem;
        }

        .permission-label {
            font-size: 0.875rem;
            color: #374151;
        }

        .dropdown-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .save-btn, .cancel-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .save-btn {
            background: #10b981;
            color: white;
        }

        .save-btn:hover {
            background: #059669;
        }

        .cancel-btn {
            background: #ef4444;
            color: white;
        }

        .cancel-btn:hover {
            background: #dc2626;
        }

        /* æƒé™æ ‡ç­¾æ ·å¼ */
        .permission-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .permission-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 500;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .error {
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .admin-container {
                margin: 1rem;
                padding: 1rem;
            }

            .permissions-table {
                font-size: 0.8rem;
            }

            .dropdown-menu {
                min-width: 250px;
            }
        }
    </style>
</head>
<body>
<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="admin-controls">
            <input class="user-search" id="userSearch" placeholder="æœç´¢ç”¨æˆ·..." type="text">
            <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ åˆ·æ–°</button>
            <a class="btn-back" href="/interview">
                <i class="fas fa-arrow-left"></i>è¿”å›ç®€å†åˆ†æ
            </a>
        </div>
    </div>

    <div id="messageContainer"></div>

    <table class="permissions-table" id="permissionsTable">
        <thead>
        <tr>
            <th width="25%">ç”¨æˆ·ä¿¡æ¯</th>
            <th width="25%">è§’è‰²</th>
            <th width="40%">æƒé™</th>
            <th width="10%">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="permissionsBody">
        <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
        </tbody>
    </table>
</div>

<script>
    // å…¨å±€å˜é‡
    let allPermissions = [];
    let allUsers = [];
    let userRolesMap = new Map();
    let currentEditingUserId = null;
    let allRoles = [];
    // å…¨å±€æ¸²æŸ“é”
    let isRendering = false;
    let renderQueue = [];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        checkAdminAccess();
        loadAllData();
        initSearch();
    });

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadAllData() {
        try {
            showLoading(true);
            await Promise.all([
                loadAllUsers(),
                loadAllPermissions(),
                loadAllRoles()
            ]);

            await loadAllUserRoles();
            await renderUserPermissions(allUsers);
        } catch (error) {
            showMessage('error', 'æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // åŠ è½½æ‰€æœ‰è§’è‰²
    async function loadAllRoles() {
        try {
            const response = await fetch('/api/roles', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) throw new Error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥');

            allRoles = await response.json();
            console.log('è§’è‰²æ•°æ®åŠ è½½æˆåŠŸ:', allRoles);
        } catch (error) {
            console.error('åŠ è½½è§’è‰²åˆ—è¡¨é”™è¯¯:', error);
            showMessage('error', error.message);
        }
    }


    // åŠ è½½æ‰€æœ‰ç”¨æˆ·
    async function loadAllUsers() {
        try {
            const response = await fetch('/api/admin/permissions/users', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) throw new Error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');

            const users = await response.json();

            // åŠ å¼ºå»é‡é€»è¾‘ï¼šæ ¹æ®IDå’Œç”¨æˆ·ååŒé‡å»é‡
            const userMap = new Map();
            users.forEach(user => {
                if (!userMap.has(user.id) && !userMap.has(user.username)) {
                    userMap.set(user.id, user);
                    userMap.set(user.username, user);
                }
            });

            allUsers = Array.from(userMap.values());

            console.log('ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸï¼ˆåŠ å¼ºå»é‡åï¼‰:', allUsers);

        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨é”™è¯¯:', error);
            showMessage('error', error.message);
        }
    }


    // åŠ è½½æ‰€æœ‰æƒé™
    async function loadAllPermissions() {
        try {
            const response = await fetch('/api/permissions', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) throw new Error('åŠ è½½æƒé™åˆ—è¡¨å¤±è´¥');

            allPermissions = await response.json();
            console.log('æƒé™æ•°æ®åŠ è½½æˆåŠŸ:', allPermissions);
        } catch (error) {
            console.error('åŠ è½½æƒé™åˆ—è¡¨é”™è¯¯:', error);
            showMessage('error', error.message);
        }
    }

    // æ¸²æŸ“å‡½æ•°
    async function renderUserPermissions(users) {
        // å¦‚æœæ­£åœ¨æ¸²æŸ“ï¼ŒåŠ å…¥é˜Ÿåˆ—
        if (isRendering) {
            renderQueue.push(users);
            return;
        }

        isRendering = true;

        try {
            const tbody = document.getElementById('permissionsBody');
            tbody.innerHTML = '';

            if (!users || !Array.isArray(users)) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem;">
                        æ•°æ®åŠ è½½å¼‚å¸¸æˆ–æš‚æ— ç”¨æˆ·æ•°æ®
                    </td>
                </tr>
            `;
                return;
            }

            if (users.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem;">
                        æš‚æ— ç”¨æˆ·æ•°æ®
                    </td>
                </tr>
            `;
                return;
            }

            // æ¸²æŸ“å‰å†æ¬¡å»é‡
            const uniqueUsers = users.reduce((unique, user) => {
                if (!unique.some(u => u.id === user.id)) {
                    unique.push(user);
                }
                return unique;
            }, []);

            console.log('å‡†å¤‡æ¸²æŸ“ç”¨æˆ·æ•°é‡ï¼ˆå»é‡åï¼‰:', uniqueUsers.length);

            // ä¸ºæ¯ä¸ªç”¨æˆ·è·å–æƒé™
            for (const user of uniqueUsers) {
                const userPermissions = await getUserPermissions(user.id);
                const userRoles = userRolesMap.get(user.id) || [];
                const currentRole = userRoles.length > 0 ? userRoles[0] : null; // åªå–ç¬¬ä¸€ä¸ªè§’è‰²

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <div class="user-info">
                    <span class="username">${user.username || 'æœªçŸ¥ç”¨æˆ·'}</span>
                    <span class="user-email">${user.email || 'æ— é‚®ç®±'}</span>
                </div>
            </td>
            <td>
                ${renderSingleRoleSelector(currentRole, user.id)}
            </td>
            <td>
                ${renderPermissionsTags(userPermissions)}
            </td>
            <td>
                <div class="permissions-dropdown">
                    <button class="dropdown-toggle" onclick="togglePermissionsDropdown(${user.id})">
                        ç®¡ç†æƒé™
                    </button>
                    <div class="dropdown-menu" id="dropdown-${user.id}">
                        ${renderPermissionsDropdown(userPermissions, user.id)}
                    </div>
                </div>
            </td>
        `;

                tbody.appendChild(row);
            }
        } finally {
            isRendering = false;

            // å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªæ¸²æŸ“ä»»åŠ¡
            if (renderQueue.length > 0) {
                const nextUsers = renderQueue.shift();
                setTimeout(() => renderUserPermissions(nextUsers), 100);
            }
        }
    }

    // æ¸²æŸ“å•ä¸€è§’è‰²é€‰æ‹©å™¨
    function renderSingleRoleSelector(currentRole, userId) {
        return `
        <div class="single-role-management">
            <div class="current-role-display">
                ${currentRole ? `
                    <span class="current-role-badge">
                        ${currentRole.displayName || currentRole.name}
                    </span>
                ` : '<span style="color: #6b7280;">æœªåˆ†é…è§’è‰²</span>'}
            </div>

            <div class="role-change-section">
                <select class="role-dropdown" id="role-select-${userId}">
                    <option value="">é€‰æ‹©æ–°è§’è‰²</option>
                    ${renderRoleOptions(allRoles, currentRole)}
                </select>
                <button class="change-role-btn" onclick="changeUserRole(${userId})">
                    æ›´æ”¹è§’è‰²
                </button>
            </div>

            ${currentRole ? `
                <div class="role-info">
                    <small style="color: #6b7280;">
                        å½“å‰è§’è‰²: ${currentRole.displayName || currentRole.name}
                    </small>
                </div>
            ` : ''}
        </div>
    `;
    }

    // æ¸²æŸ“è§’è‰²é€‰é¡¹
    function renderRoleOptions(allRoles, currentRole) {
        const currentRoleId = currentRole ? currentRole.id : null;

        return allRoles.map(role =>
            `<option value="${role.id}" ${role.id === currentRoleId ? 'selected disabled' : ''}>
            ${role.displayName || role.name}
        </option>`
        ).join('');
    }

    async function changeUserRole(userId) {
        try {
            const roleSelect = document.getElementById(`role-select-${userId}`);
            const newRoleId = roleSelect.value;

            if (!newRoleId) {
                showMessage('warning', 'è¯·é€‰æ‹©æ–°è§’è‰²');
                return;
            }

            // è·å–å½“å‰ç”¨æˆ·è§’è‰²
            const currentRoles = userRolesMap.get(userId) || [];
            const currentRole = currentRoles.length > 0 ? currentRoles[0] : null;

            // å¦‚æœé€‰æ‹©çš„æ˜¯å½“å‰è§’è‰²ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (currentRole && currentRole.id.toString() === newRoleId) {
                showMessage('info', 'è§’è‰²æœªå‘ç”Ÿå˜åŒ–');
                return;
            }

            // ç¡®è®¤æ›´æ”¹
            const newRole = allRoles.find(r => r.id.toString() === newRoleId);
            if (!newRole) {
                showMessage('error', 'é€‰æ‹©çš„è§’è‰²æ— æ•ˆ');
                return;
            }

            const confirmMessage = currentRole ?
                `ç¡®å®šå°†è§’è‰²ä» "${currentRole.displayName || currentRole.name}" æ›´æ”¹ä¸º "${newRole.displayName || newRole.name}" å—ï¼Ÿ` :
                `ç¡®å®šåˆ†é…è§’è‰² "${newRole.displayName || newRole.name}" å—ï¼Ÿ`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // å…ˆç§»é™¤æ‰€æœ‰ç°æœ‰è§’è‰²ï¼ˆå¦‚æœæœ‰ï¼‰
            await removeAllRolesFromUser(userId);

            // æ·»åŠ æ–°è§’è‰²
            const response = await fetch(`/api/user-roles?userId=${userId}&roleId=${newRoleId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'æ›´æ”¹è§’è‰²å¤±è´¥');
            }

            // è·å–æ–°è§’è‰²çš„æƒé™
            const roleResponse = await fetch(`/api/roles/${newRoleId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!roleResponse.ok) {
                const errorText = await roleResponse.text();
                showMessage('warning', 'è§’è‰²æ›´æ”¹æˆåŠŸï¼Œä½†è·å–è§’è‰²æƒé™å¤±è´¥: ' + errorText);
            } else {
                const roleData = await roleResponse.json();
                // æå–æƒé™IDåˆ—è¡¨
                const permissionIds = roleData.permissions ? 
                    roleData.permissions.map(perm => perm.id) : [];
                
                if (permissionIds.length > 0) {
                    // å°†ç”¨æˆ·æƒé™é‡ç½®ä¸ºè§’è‰²æƒé™
                    const permResponse = await fetch(`/api/admin/permissions/assign?userId=${userId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(permissionIds)
                    });
                    
                    if (!permResponse.ok) {
                        const errorText = await permResponse.text();
                        showMessage('warning', 'è§’è‰²æ›´æ”¹æˆåŠŸï¼Œä½†åŒæ­¥æƒé™å¤±è´¥: ' + errorText);
                    } else {
                        showMessage('success', 'è§’è‰²æ›´æ”¹æˆåŠŸï¼Œå¹¶å·²åŒæ­¥é‡ç½®ç”¨æˆ·æƒé™');
                    }
                } else {
                    showMessage('success', 'è§’è‰²æ›´æ”¹æˆåŠŸï¼Œè¯¥è§’è‰²æ— å…³è”æƒé™');
                }
            }

            // é‡æ–°åŠ è½½æ•°æ®
            await loadAllUserRoles();
            await renderUserPermissions(allUsers);

        } catch (error) {
            console.error('æ›´æ”¹è§’è‰²é”™è¯¯:', error);
            showMessage('error', error.message);
        }
    }

    async function removeAllRolesFromUser(userId) {
        try {
            const response = await fetch(`/api/user-roles/users/${userId}/all`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'ç§»é™¤æ‰€æœ‰è§’è‰²å¤±è´¥');
            }

            console.log(`æˆåŠŸç§»é™¤ç”¨æˆ· ${userId} çš„æ‰€æœ‰è§’è‰²`);
            return true;
        } catch (error) {
            console.error('ç§»é™¤æ‰€æœ‰è§’è‰²é”™è¯¯:', error);
            throw error;
        }
    }

    // åŠ è½½ç”¨æˆ·è§’è‰²ä¿¡æ¯
    async function loadAllUserRoles() {
        try {
            const rolePromises = allUsers.map(user =>
                fetch(`/api/user-roles/users/${user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                })
                    .then(response => {
                        if (!response.ok) throw new Error(`è·å–ç”¨æˆ· ${user.id} è§’è‰²å¤±è´¥`);
                        return response.json();
                    })
                    .then(roles => {
                        userRolesMap.set(user.id, roles);
                        return {userId: user.id, roles};
                    })
                    .catch(error => {
                        console.error(`è·å–ç”¨æˆ· ${user.id} è§’è‰²é”™è¯¯:`, error);
                        userRolesMap.set(user.id, []);
                        return {userId: user.id, roles: []};
                    })
            );

            await Promise.all(rolePromises);
            console.log('æ‰€æœ‰ç”¨æˆ·è§’è‰²åŠ è½½å®Œæˆ:', userRolesMap);
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·è§’è‰²é”™è¯¯:', error);
            showMessage('error', 'åŠ è½½ç”¨æˆ·è§’è‰²å¤±è´¥: ' + error.message);
        }
    }

    // è·å–ç”¨æˆ·æƒé™
    async function getUserPermissions(userId) {
        try {
            const response = await fetch(`/api/admin/user-permissions/users/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) throw new Error('è·å–ç”¨æˆ·æƒé™å¤±è´¥');

            const permissions = await response.json();
            console.log('ç”¨æˆ·æƒé™æ•°æ®:', permissions);
            return permissions;
        } catch (error) {
            console.error('è·å–ç”¨æˆ·æƒé™é”™è¯¯:', error);
            showMessage('error', error.message);
            return [];
        }
    }

    // æ¸²æŸ“æƒé™æ ‡ç­¾
    function renderPermissionsTags(permissions) {
        if (!permissions || permissions.length === 0) {
            return '<span style="color: #6b7280;">æš‚æ— æƒé™</span>';
        }

        // æŒ‰æƒé™ç±»åˆ«åˆ†ç»„æ˜¾ç¤º
        const groupedPermissions = groupPermissionsByCategory(permissions);

        let html = '';
        for (const [category, perms] of Object.entries(groupedPermissions)) {
            html += `<div class="permission-category">
                    <strong>${category}:</strong>
                    <div class="permission-tags">
                        ${perms.map(perm =>
                `<span class="permission-tag">${perm.displayName}</span>`
            ).join(' ')}
                    </div>
                 </div>`;
        }

        return html;
    }

    // æŒ‰æƒé™ç±»åˆ«åˆ†ç»„
    function groupPermissionsByCategory(permissions) {
        const categories = {
            'ä»ªè¡¨ç›˜': ['dashboard:access'],
            'ç®€å†ç®¡ç†': ['resume:create', 'resume:view', 'resume:edit', 'resume:delete', 'resume:download'],
            'èŒä½ç®¡ç†': ['job:view', 'job:apply'],
            'ä¼ä¸šç®¡ç†': ['company:view'],
            'ç³»ç»Ÿç®¡ç†': ['admin:access', 'user:view', 'user:manage', 'role:manage', 'system:settings']
        };

        const grouped = {};

        permissions.forEach(perm => {
            let category = 'å…¶ä»–';
            for (const [cat, names] of Object.entries(categories)) {
                if (names.includes(perm.name)) {
                    category = cat;
                    break;
                }
            }

            if (!grouped[category]) {
                grouped[category] = [];
            }
            grouped[category].push(perm);
        });

        return grouped;
    }

    // æ¸²æŸ“æƒé™ä¸‹æ‹‰èœå•
    function renderPermissionsDropdown(userPermissions, userId) {
        if (allPermissions.length === 0) {
            return '<div>æƒé™åˆ—è¡¨åŠ è½½ä¸­...</div>';
        }

        const groupedPermissions = groupPermissionsByCategory(allPermissions);
        const allChecked = userPermissions.length === allPermissions.length;

        let html = `<div style="max-height: 400px; overflow-y: auto;">
                <div class="select-all-section">
                    <input type="checkbox" id="select-all-${userId}"
                           ${allChecked ? 'checked' : ''}
                           onchange="toggleSelectAll(${userId})">
                    <label for="select-all-${userId}">å…¨é€‰/å–æ¶ˆå…¨é€‰</label>
                </div>`;

        for (const [category, perms] of Object.entries(groupedPermissions)) {
            const categoryChecked = perms.every(perm =>
                userPermissions.some(p => p.id === perm.id)
            );

            html += `<div class="permission-category-dropdown">
                    <div class="category-header">
                        <input type="checkbox"
                               id="category-${userId}-${category.replace(/\s+/g, '-')}"
                               ${categoryChecked ? 'checked' : ''}
                               onchange="toggleCategory(${userId}, '${category}')">
                        <label for="category-${userId}-${category.replace(/\s+/g, '-')}">
                            <strong>${category}</strong>
                        </label>
                    </div>
                    ${perms.map(perm => `
                        <div class="permission-item">
                            <input type="checkbox"
                                   class="permission-checkbox category-${category.replace(/\s+/g, '-')}"
                                   id="perm-${userId}-${perm.id}"
                                   value="${perm.id}"
                                   ${userPermissions.some(p => p.id === perm.id) ? 'checked' : ''}>
                            <label class="permission-label" for="perm-${userId}-${perm.id}">
                                ${perm.displayName}
                                <small style="color: #6b7280; display: block;">${perm.description}</small>
                            </label>
                        </div>
                    `).join('')}
                 </div>`;
        }

        html += `</div>
             <div class="dropdown-actions">
                 <button class="save-btn" onclick="savePermissions(${userId})">ä¿å­˜</button>
                 <button class="cancel-btn" onclick="closeDropdown(${userId})">å–æ¶ˆ</button>
             </div>`;

        return html;
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll(userId) {
        const selectAll = document.getElementById(`select-all-${userId}`);
        const checkboxes = document.querySelectorAll(`#dropdown-${userId} .permission-checkbox`);

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰ç±»åˆ«
    function toggleCategory(userId, category) {
        const categoryCheckbox = document.getElementById(`category-${userId}-${category.replace(/\s+/g, '-')}`);
        const checkboxes = document.querySelectorAll(`#dropdown-${userId} .category-${category.replace(/\s+/g, '-')}`);

        checkboxes.forEach(checkbox => {
            checkbox.checked = categoryCheckbox.checked;
        });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        checkAdminAccess();
        loadAllData();
        initSearch();
    });

    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    async function checkAdminAccess() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            return false;
        }

        try {
            const response = await fetch('/api/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                    return false;
                }
                throw new Error('æƒé™æ£€æŸ¥å¤±è´¥');
            }

            const userData = await response.json();
            const hasAdminAccess = userData.roles &&
                (userData.roles.includes('super_admin') || userData.roles.includes('admin'));

            if (!hasAdminAccess) {
                showMessage('error', 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢');
                setTimeout(() => window.location.href = '/', 2000);
                return false;
            }

            return true;
        } catch (error) {
            console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
            window.location.href = '/login';
            return false;
        }
    }


    // åˆ‡æ¢æƒé™ä¸‹æ‹‰èœå•
    function togglePermissionsDropdown(userId) {
        // å…³é—­å…¶ä»–æ‰€æœ‰ä¸‹æ‹‰èœå•
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu.id !== `dropdown-${userId}`) {
                menu.classList.remove('show');
            }
        });

        // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
        const dropdown = document.getElementById(`dropdown-${userId}`);
        dropdown.classList.toggle('show');
    }

    // å…³é—­ä¸‹æ‹‰èœå•
    function closeDropdown(userId) {
        const dropdown = document.getElementById(`dropdown-${userId}`);
        dropdown.classList.remove('show');
    }

    // ä¿å­˜æƒé™
    async function savePermissions(userId) {
        try {
            showLoading(true);

            // è·å–é€‰ä¸­çš„æƒé™IDå¹¶è¿‡æ»¤nullå€¼
            const selectedPermissions = Array.from(
                document.querySelectorAll(`#dropdown-${userId} input[type="checkbox"]:checked`)
            )
                .map(input => {
                    const value = parseInt(input.value);
                    return isNaN(value) ? null : value; // è½¬æ¢å¤±è´¥æ—¶è¿”å›null
                })
                .filter(permissionId => permissionId !== null); // è¿‡æ»¤æ‰nullå€¼

            console.log('è¿‡æ»¤åçš„æƒé™ID:', selectedPermissions);

            if (selectedPermissions.length === 0) {
                showMessage('warning', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆæƒé™');
                return;
            }

            const response = await fetch(`/api/admin/user-permissions/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(selectedPermissions)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'ä¿å­˜æƒé™å¤±è´¥');
            }

            showMessage('success', 'æƒé™æ›´æ–°æˆåŠŸ');
            closeDropdown(userId);

            // é‡æ–°åŠ è½½æ•°æ®
            await loadAllData();
        } catch (error) {
            console.error('ä¿å­˜æƒé™é”™è¯¯:', error);
            showMessage('error', error.message);
        } finally {
            showLoading(false);
        }
    }

    // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
    function showLoading(show) {
        const table = document.getElementById('permissionsTable');
        const refreshBtn = document.querySelector('.refresh-btn');

        if (show) {
            table.classList.add('loading');
            refreshBtn.innerHTML = '<div class="spinner"></div>';
        } else {
            table.classList.remove('loading');
            refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°';
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(type, text) {
        const container = document.getElementById('messageContainer');
        const message = document.createElement('div');
        message.className = `message ${type}`;
        message.textContent = text;

        container.appendChild(message);

        // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (message.parentNode === container) {
                container.removeChild(message);
            }
        }, 5000);
    }

    // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
    function initSearch() {
        const searchInput = document.getElementById('userSearch');
        searchInput.addEventListener('input', debounce(function (e) {
            filterUsers(e.target.value);
        }, 300));
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // è¿‡æ»¤ç”¨æˆ·
    function filterUsers(searchTerm) {
        const rows = document.querySelectorAll('#permissionsBody tr');
        rows.forEach(row => {
            const username = row.querySelector('.username').textContent.toLowerCase();
            const email = row.querySelector('.user-email').textContent.toLowerCase();
            const searchLower = searchTerm.toLowerCase();

            if (username.includes(searchLower) || email.includes(searchLower)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // å¯¼å‡ºCSV
    function exportToCSV() {
        showMessage('info', 'CSVå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', function (event) {
        if (!event.target.closest('.permissions-dropdown')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });
</script>
</body>
</html>